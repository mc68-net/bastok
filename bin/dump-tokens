#!/usr/bin/env python3

from    os.path  import abspath, dirname, join
from    site  import addsitedir
BASEDIR = dirname(dirname(abspath(__file__)))
if __name__ == '__main__': addsitedir(join(BASEDIR, 'pylib'))

from    argparse  import ArgumentParser
import  sys

def die(exitcode, *msglines):
    for l in msglines:
        print(l, file=sys.stderr)
    exit(exitcode)

def parseargs():
    p = ArgumentParser(description='Search MS-BASIC ROM image for tokens')
    arg = p.add_argument

    arg('-s', '--start', type=int, default=0x34c1,
            help='start of token table')
    arg('input', help='input file (required); use `-` for stdin')

    return p.parse_args()

def main(args):

    if args.input == '-':
        f = sys.stdin.buffer
    else:
        f = open(args.input, 'rb')

    bs = f.read()

    alptab_addr = args.start
    print(' '*44 + '# ALPTAB at 0x{:04X}'.format(alptab_addr))
    a = alptab_addr
    kt = dict()
    # FIXME: we know the ATAB will be at the end of this table
    # and the table has 26 entries, so we can work our the mapped
    # address of the table. We should calculate this and work out the file
    # offsets based on this. Not all ROMS will be mapped to address 0x0000
    for i in range(0,26):
        prefix = chr(ord('A') + i)
        tab = 0x100 * bs[a+1] + bs[a]
        print(' '*44  + "# addr=${:04X} '{}' table".format(tab, prefix))
        a += 2
        p = tab
        while True :
            x = bs[p]
            if x == 0x00:
                p += 1
                break
            else:
                keyword = prefix
                addr = p
                while x < 0x80:
                    keyword += chr(x)
                    p += 1
                    x = bs[p]
                keyword += chr(x & 0x7f)
                p += 1
                token = bs[p]
                if token < 0x80:
                    token = b'\xFF' + bytes( (0x80 + token,) )
                else:
                    token = bytes( (token,) )
                p += 1
                tchars = ''.join(map(r'\x{:02X}'.format, token))
                print("    (b'{:16} '{:15}),  # addr=${:04X}" \
                    .format(tchars + "',", keyword + "',", addr))
                kt[keyword] = token

if __name__ == '__main__':
    main(parseargs())
