#!/usr/bin/env python3

from    os.path  import abspath, dirname, join
from    site  import addsitedir
BASEDIR = dirname(dirname(abspath(__file__)))
if __name__ == '__main__': addsitedir(join(BASEDIR, 'pylib'))

from    argparse  import ArgumentParser
from    functools  import partial
from    io  import TextIOWrapper
from    sys  import argv, stdin, stdout

from    bastok.blines  import blines
from    bastok.msx2re  import tokenize
from    bastok.msxchars import CHARMAP

####################################################################

def openarg(**kwargs):
    ''' Return a function that, given a `str` filename, returns
        a function that will call `open()` on that filename with
        the additional `kwargs`. This can be passed as the ``type``
        parameter to `ArgumentParser.add_argument()` to produce
        a function callable with ``with f as file_handle:``.
    '''
    def opener(filename):
        return partial(open, filename, **kwargs)
    return opener

def parseargs():
    p = ArgumentParser(description='MSX-BASIC tokenizer')
    arg = p.add_argument

    arg('-c', '--charset', default='ja',
        help='MSX charset: ja (default), int, ar, ru, etc.')
    arg('-e', '--unexpand', action='store_true',
        help='remove spaces to reduce code size')
    arg('input', nargs='?', type=openarg(encoding='UTF-8'),
        default=lambda: TextIOWrapper(stdin.buffer, encoding='UTF-8'),
        help='input file (default stdin)')
    arg('output', nargs='?', type=openarg(mode='wb'),
        default=lambda: stdout.buffer,
        help='output file (default stdout)')

    return p.parse_args()

def main(args):
    charmap = CHARMAP.get(args.charset)
    if charmap is None:
        die(3, 'Unknown MSX charset: {}'.format(args.charset),
            'Known charsets:',
            *[ ' {:>4}: {}'.format(k, v.description)
               for k, v in sorted(CHARMAP.items()) ]
            )

    with args.input() as f:
        tlines = tokenize(charmap, blines(f.readlines()))
    with args.output() as f:
        tlines.write_to(f)
    # If stdin and/or stdout were used, they are now closed.

if __name__ == '__main__':
    main(parseargs())

